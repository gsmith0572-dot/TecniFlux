Nueva estrategia (sin l√≠mites de tama√±o)
En vez de incrustar el PDF en base64, vamos a hacer:


Un endpoint que sirve el PDF crudo desde el backend (stream/buffer), como ya ten√≠as (Content-Type: application/pdf).


Un endpoint que devuelve una p√°gina HTML con un <iframe>/<embed> apuntando a ese endpoint, pero:


Metido en un contenedor con overflow: hidden


Mueve el PDF hacia arriba con margin-top: -40px


Eso ‚Äúsaca‚Äù la barra de herramientas de la vista ‚Üí el usuario no ve bot√≥n de descargar.




No es 100% imposible copiar (nadie lo puede), pero hace mucho m√°s dif√≠cil que te roben todo el cat√°logo.

‚úÖ PASO 1 ‚Äì Actualizar pdf-viewer-template.ts
Abre el archivo server/pdf-viewer-template.ts que creamos antes y reemplaza TODO por esto:
// server/pdf-viewer-template.ts

export function renderSecurePDFViewer(diagramId: string): string {
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TecniFlux - Visor Seguro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #05060a;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }
    #header {
      padding: 8px 12px;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #0f172a, #020617);
      border-bottom: 1px solid #1f2933;
    }
    #header span.app-name {
      font-weight: 600;
      letter-spacing: 0.03em;
      color: #38bdf8;
    }
    #header span.note {
      opacity: 0.8;
      font-size: 12px;
    }
    #viewer-wrapper {
      flex: 1;
      width: 100%;
      height: 100%;
      overflow: hidden; /* escondemos la barra superior del visor PDF */
      background: #05060a;
      position: relative;
    }
    #viewer {
      position: absolute;
      top: -40px; /* mueve el PDF hacia arriba para ocultar la barra */
      left: 0;
      width: 100%;
      height: calc(100% + 40px);
      border: none;
      background: #05060a;
    }
  </style>
</head>

<body>
  <div id="wrapper">
    <div id="header">
      <span class="app-name">TecniFlux ‚Ä¢ Visor seguro</span>
      <span class="note">S√≥lo visualizaci√≥n ‚Ä¢ Descarga deshabilitada</span>
    </div>
    <div id="viewer-wrapper">
      <iframe
        id="viewer"
        src="/api/diagrams/${diagramId}/file#toolbar=0&navpanes=0"
      ></iframe>
    </div>
  </div>
</body>
</html>
`;
}

üëâ F√≠jate que aqu√≠ ya no pasamos el PDF en base64.
Simplemente apuntamos a /api/diagrams/${diagramId}/file.

‚úÖ PASO 2 ‚Äì Import ya est√° OK
En server/routes.ts ya tienes este import (si no, agr√©galo arriba con los dem√°s):
import { renderSecurePDFViewer } from "./pdf-viewer-template";


‚úÖ PASO 3 ‚Äì Cambiar la ruta /api/diagrams/:id/view y crear /api/diagrams/:id/file
Ahora en server/routes.ts vamos a hacer dos cosas:
3.1 Reemplazar la ruta /api/diagrams/:id/view
Busca esta ruta (la que ahora mismo se encarga de traer el PDF desde Drive y enviar el buffer):
// Serve PDF through secure proxy (NEVER expose directUrl to frontend)
app.get("/api/diagrams/:id/view", requireAuth, async (req, res) => {
  // ... TODO el c√≥digo largo que termina en res.send(buffer);
});

Y reempl√°zala COMPLETA por esta versi√≥n s√∫per simple:
// Serve HTML page with secure PDF viewer (no direct download UI)
app.get("/api/diagrams/:id/view", requireAuth, async (req, res) => {
  try {
    const diagramId = req.params.id;

    // Opcional: podr√≠as validar que el diagrama exista,
    // pero igual la ruta /file har√° validaciones fuertes.
    res.setHeader("Content-Type", "text/html; charset=utf-8");
    res.setHeader(
      "Cache-Control",
      "no-store, no-cache, must-revalidate, private"
    );
    res.setHeader("X-Frame-Options", "SAMEORIGIN");
    res.setHeader("Referrer-Policy", "no-referrer");

    const html = renderSecurePDFViewer(diagramId);
    res.send(html);
  } catch (error) {
    console.error("[PDF View] Error:", error);
    res.status(500).json({ error: "Error al cargar visor seguro" });
  }
});

Esta ruta ya no toca el PDF.
Solo devuelve la p√°gina HTML que contiene el <iframe> apuntando a /file.

3.2 Crear la nueva ruta /api/diagrams/:id/file
Justo debajo de esa ruta anterior, agrega ESTA nueva ruta que s√≠ se encarga de traer el PDF desde Google Drive y hacerlo stream al navegador:
// Serve raw PDF through secure proxy (used ONLY by the internal viewer iframe)
app.get("/api/diagrams/:id/file", requireAuth, async (req, res) => {
  const diagramId = req.params.id;
  console.log(`[PDF File] Request received for diagram: ${diagramId}`);
  
  try {
    const userId = req.session!.userId!;

    // 1. Verify user exists and has active subscription
    const user = await storage.getUser(userId);
    if (!user) {
      console.log(`[PDF File] User not found: ${userId}`);
      return res.status(404).json({ error: "Usuario no encontrado" });
    }

    if (!user.isActive) {
      console.log(`[PDF File] User inactive: ${userId}`);
      return res.status(403).json({ error: "Cuenta inactiva" });
    }

    if (user.subscriptionStatus !== "active") {
      console.log(
        `[PDF File] Subscription inactive: ${userId}, status: ${user.subscriptionStatus}`
      );
      return res.status(403).json({ error: "Suscripci√≥n inactiva" });
    }

    // 2. Verify diagram exists
    const diagram = await storage.getDiagram(diagramId);
    if (!diagram) {
      console.log(`[PDF File] Diagram not found: ${diagramId}`);
      return res.status(404).json({ error: "Diagrama no encontrado" });
    }

    if (!diagram.directUrl) {
      console.log(`[PDF File] No directUrl for diagram: ${diagramId}`);
      return res.status(404).json({ error: "URL del archivo no disponible" });
    }

    console.log(`[PDF File] Fetching PDF from Drive for diagram: ${diagramId}`);

    // 3. Fetch PDF from Google Drive
    const response = await fetch(diagram.directUrl, {
      redirect: "follow",
      headers: {
        "User-Agent":
          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
      },
    });

    if (!response.ok) {
      console.error(
        `[PDF File] Failed to fetch PDF: ${response.status} ${response.statusText}`
      );
      return res.status(502).json({ error: "Error al obtener el archivo" });
    }

    // 4. Stream or buffer ‚Äì aqu√≠ usamos buffer como ya ten√≠as
    const arrayBuffer = await response.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);

    console.log(
      `[PDF File] PDF loaded, size: ${buffer.length} bytes, sending to client`
    );

    // 5. Set headers for inline PDF
    res.setHeader("Content-Type", "application/pdf");
    res.setHeader("Content-Disposition", 'inline; filename="diagram.pdf"');
    res.setHeader("Content-Length", buffer.length.toString());
    res.setHeader(
      "Cache-Control",
      "no-store, no-cache, must-revalidate, private"
    );
    res.setHeader("X-Content-Type-Options", "nosniff");
    res.setHeader("X-Frame-Options", "SAMEORIGIN");
    res.setHeader("Referrer-Policy", "no-referrer");

    res.send(buffer);
  } catch (error) {
    console.error("[PDF File] Error:", error);
    res.status(500).json({ error: "Error al servir el archivo" });
  }
});

üëâ Esta ruta hace lo que antes hac√≠a /view, pero ahora:


Solo la usa el visor interno


Nunca la llama el usuario directamente desde el front (t√∫ no pones el link en ning√∫n lado)


El front siempre abre /api/diagrams/:id/view (HTML con iframe), NO /file



‚úÖ PASO 4 ‚Äì Verificar el front
En tu componente React donde abres el diagrama (por ejemplo en DiagramDetailDialog.tsx), aseg√∫rate de que el bot√≥n use esto:
const handleOpenPDF = () => {
  if (!diagram.id) return;
  window.open(`/api/diagrams/${diagram.id}/view`, "_blank");
};

üëâ Muy importante:
No uses diagram.directUrl ni diagram.fileUrl en el front.
Solo usa tus rutas /api/diagrams/....

üìå Qu√© va a pasar ahora en la pr√°ctica


El usuario hace clic en ‚ÄúVer diagrama‚Äù.


Se abre una nueva pesta√±a:
https://tudominio.com/api/diagrams/123/view


Esa URL devuelve una p√°gina oscura, con el header ‚ÄúTecniFlux ‚Ä¢ Visor seguro‚Äù.


El <iframe> dentro carga ‚Ä¶/api/diagrams/123/file, que:


Valida usuario, plan, suscripci√≥n


Trae el PDF de Drive


Lo env√≠a como application/pdf




El navegador muestra el visor PDF est√°ndar‚Ä¶ PERO:


La barra de herramientas est√° fuera de la vista (con top: -40px y overflow: hidden)


No hay bot√≥n de descarga visible


No hay UI de Google Drive





Si despu√©s de probarlo todav√≠a ves alg√∫n bot√≥n de ‚Äúguardar‚Äù o similar, dime qu√© navegador est√°s usando (Chrome, Safari, m√≥vil, etc.) y ajustamos el CSS/altura para ‚Äúcortar‚Äù mejor la parte de arriba del viewer.
Cuando lo pruebes con un PDF grande, cu√©ntame:


¬øYa se ve el diagrama?


¬øVes todav√≠a alg√∫n bot√≥n de descargar?


¬øSe siente fluido el scroll?


